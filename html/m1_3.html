<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>layout 管理系统大布局 - Layui</title>
    <link rel="stylesheet" href="../layui-v2.6.8/layui/css/layui.css">
    <link rel="stylesheet" href="../puill/quill.snow.css">
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/wenfa.css">
    <link rel="stylesheet" href="../cropper/cropper.css">
    <style>
        .layui-body {
            padding: 15px;
        }


        /* 设置卡片主体区域的宽度 */
        .layui-card-body {
            width: 500px;
        }

        /* 设置按钮行的样式 */
        .row2 {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* 设置裁剪区域的样式 */
        .cropper-box {
            width: 350px;
            height: 350px;
            background-color: cyan;
            overflow: hidden;
        }

        /* 设置第一个预览区域的样式 */
        .w100 {
            width: 100px;
            height: 100px;
            background-color: gray;
        }

        /* 设置第二个预览区域的样式 */
        .w50 {
            width: 50px;
            height: 50px;
            background-color: gray;
            margin-top: 50px;
        }

        /* 设置预览区域下方文本的样式 */
        .size {
            font-size: 12px;
            color: gray;
            text-align: center;
        }

        /* 设置图片行的样式 */
        .row1 {
            display: flex;
        }

        /* 设置 preview-box 区域的的样式 */
        .preview-box {
            display: flex;
            flex-direction: column;
            flex: 1;
            align-items: center;
        }

        /* 设置 img-preview 区域的样式 */
        .img-preview {
            overflow: hidden;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div class="layui-layout layui-layout-admin">
        <!-- 头部 -->
        <div class="layui-header">
            <!-- 头部区域（可配合layui 已有的水平导航） -->
            <ul class="layui-nav layui-layout-right" lay-filter="header-nav">
                <li class="layui-nav-item layui-hide layui-show-md-inline-block">
                    <a href="javascript:;" id="header-avatar">
                        <div class="text-avatar">X</div>
                        个人中心<span class="layui-nav-more"></span>
                    </a>
                    <dl class="layui-nav-child layui-anim layui-anim-upbit">
                        <dd><a href="./m2_1.html" target="fm">基本资料</a></dd>
                        <dd><a href="./m2_2.html" target="fm">更换头像</a></dd>
                        <dd><a href="./m2_3.html" target="fm">重置密码</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item layui-hide-xs">
                    <!-- 退出登录的链接 -->
                    <a href="javascript:;" class="logout"><span class="iconfont icon-tuichu"></span>退出</a>
                </li>
            </ul>
        </div>

        <div class="layui-side layui-bg-black">
            <div class="layui-side-scroll">
                <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
                <div class="user-info-box">
                    <div class="text-avatar">X</div>
                    <span class="welcome">&nbsp;欢迎&nbsp; xie123456</span>
                </div>

                <!-- lay-shrink="all"  收缩菜单 -->
                <ul class="layui-nav layui-nav-tree" lay-filter="test" lay-shrink="all">
                    <li class="layui-nav-item">
                        <a href="./index.html">
                            <i class="layui-icon layui-icon-home"></i> 首页
                        </a>
                    </li>
                    <!-- layui-this  选中 -->
                    <li class="layui-nav-item layui-nav-itemed">
                        <a class="" href="javascript:;"><i class="layui-icon layui-icon-list"></i> 文章管理</a>
                        <dl class="layui-nav-child">
                            <dd><a href="./m1_1.html"><i class="layui-icon layui-icon-app"></i> menu
                                    1</a></dd>
                            <dd><a href="./m1_2.html"><i class="layui-icon layui-icon-app"></i> menu
                                    2</a></dd>
                            <dd class="layui-this"><a href="./m1_3.html"><i class="layui-icon layui-icon-app"></i> menu
                                    3</a></dd>
                        </dl>
                    </li>

                    <li class="layui-nav-item">
                        <a href="javascript:;"><i class="layui-icon layui-icon-username"></i> 个人中心</a>
                        <dl class="layui-nav-child">
                            <dd><a href="./m2_1.html"><i class="layui-icon layui-icon-app"></i> list 1</a></dd>
                            <dd><a href="./m2_2.html"><i class="layui-icon layui-icon-app"></i> list 2</a></dd>
                            <dd><a href="./m2_3.html"><i class="layui-icon layui-icon-app"></i> list 3</a></dd>
                        </dl>
                    </li>
                </ul>
            </div>
        </div>

        <div class="layui-body">
            <!-- 内容主体区域 -->
            <div class="layui-card">
                <div class="layui-card-header">
                    <p>写文章</p>
                </div>
                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <label class="layui-form-label">文章标题</label>
                        <div class="layui-input-block">
                            <input type="text" name="title" required lay-verify="required" placeholder="请输入文章标题"
                                autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">文章类别</label>
                        <div class="layui-input-block">
                            <select name="cate_id" lay-verify="required">
                                <option value="">请输入文章类别</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item ipinp">
                        <label class="layui-form-label">文章内容</label>
                        <div class="layui-input-block">
                            <div id="editor"></div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <!-- 左侧的 label -->
                        <label class="layui-form-label">文章封面</label>
                        <div class="layui-input-block fms">

                            <!-- 第一行的图片裁剪和预览区域 -->
                            <div class="row1">
                                <!-- 图片裁剪区域 -->
                                <div class="cropper-box">
                                    <!-- 这个 img 标签很重要，将来会把它初始化为裁剪区域 -->
                                    <img id="image" src="../img/avatar.jpg" />
                                </div>
                            </div>
                            <!-- 第二行的按钮区域 -->
                            <div class="row2" style="margin-left: 20px;">
                                <input type="file" style="display: none;">
                                <button type="button" class="layui-btn  layui-btn-danger btn">更换封面</button>
                            </div>


                        </div>


                    </div>
                    <div class="layui-form-item tjan">
                        <div class="layui-input-block">
                            <button class="layui-btn fabu" lay-submit>发布</button>
                            <button class="layui-btn layui-btn-primary caogao" lay-submit>存为草稿</button>
                        </div>
                    </div>
                </form>
            </div>

        </div>

        <div class="layui-footer">
            <!-- 底部固定区域 -->
            底部固定区域
        </div>
    </div>

    <script src="../layui-v2.6.8/layui/layui.js"></script>
    <script src="../puill/quill.min.js"></script>
    <script>
        //JS 
        layui.use(['element', 'layer', 'util'], function () {
            var element = layui.element
                , layer = layui.layer
                , util = layui.util
                , $ = layui.$;

            //头部事件
            util.event('lay-header-event', {
                //左侧菜单事件
                menuLeft: function (othis) {
                    layer.msg('展开左侧菜单的操作', { icon: 0 });
                }
                , menuRight: function () {
                    layer.open({
                        type: 1
                        , content: '<div style="padding: 15px;">处理右侧面板的操作</div>'
                        , area: ['260px', '100%']
                        , offset: 'rt' //右上角
                        , anim: 5
                        , shadeClose: true
                    });
                }
            });

        });
    </script>
    <script>
        //Demo
        layui.use('form', function () {
            var form = layui.form;

            //监听提交
            form.on('submit(formDemo)', function (data) {
                layer.msg(JSON.stringify(data.field));
                return false;
            });
        });
    </script>
    <script>
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
            ['blockquote', 'code-block'],

            [{ 'header': 1 }, { 'header': 2 }],               // custom button values
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],      // superscript/subscript
            [{ 'indent': '-1' }, { 'indent': '+1' }],          // outdent/indent
            [{ 'direction': 'rtl' }],                         // text direction

            [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

            [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
            [{ 'font': [] }],
            [{ 'align': [] }],

            ['clean']                                         // remove formatting button
        ];

        const quill = new Quill('#editor', {
            modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow'
        });
    </script>
    <!-- 上传文件 -->
    <script>
        layui.use('upload', function () {
            var upload = layui.upload;

            //执行实例
            var uploadInst = upload.render({
                elem: '#test1' //绑定元素
                , url: '/upload/' //上传接口
                , done: function (res) {
                    //上传完毕回调
                }
                , error: function () {
                    //请求异常回调
                }
            });
        });
    </script>
    <script src="../js/jquery-3.6.0.js"></script>
    <script src="../js/template-web.js"></script>
    <script src="../cropper/Cropper.js"></script>
    <script src="../cropper/jquery-cropper.js"></script>
    <script src="../js/ajax_peizhi.js"></script>

    <!-- 统一js -->
    <script src="../js/tongyi.js"></script>


    <!-- 这个页面的js -->
    <script type="text/html" id="emt">
        {{each data}}
            <option value="{{$value.Id}}">{{$value.name}}</option>
        {{/each}}
    </script>

    <script>
        function abc(data) {

        }



        // 渲染文本类别
        function wenbenleibei() {
            $.ajax({
                url: '/my/article/cates',
                method: 'get',
                success: (data) => {
                    console.log(data);

                    let tep = template('emt', data)
                    $('[name="cate_id"]').html(tep);

                    let form = layui.form;
                    form.render()
                },
                error: (err) => {
                    console.log(err);
                }
            })
        }
        wenbenleibei();





        // 1.1 获取裁剪区域的 DOM 元素
        var $image = $('#image')
        // 1.2 配置选项
        const options = {
            // 纵横比
            aspectRatio: 1,
            // 指定预览区域
            preview: '.img-preview'
        }

        // 1.3 创建裁剪区域
        $image.cropper(options)

        $('.btn').on('click', function () {
            $('[type="file"]').click();
        })

        // 监听file的改变
        $('[type="file"]').on('change', function (e) {
            let fileList = e.target.files[0];  //获取上传的文件

            // 判断图片是否存在
            if (e.target.files.length === 0) {
                return layer.msg('请选择图片')
            }

            var newImgURL = URL.createObjectURL(fileList)   //创建路径

            $image
                .cropper('destroy')      // 销毁旧的裁剪区域
                .attr('src', newImgURL)  // 重新设置图片路径
                .cropper(options)        // 重新初始化裁剪区域
        })




        // 发布文章
        /*
            title       标题
            cate_id     分类的id
            content     文章内容
            cover_img   文章图片
            state       已发布、草稿
        */
        let state = '已发布';
        $('form').on('submit', function (e) {
            e.preventDefault();

            // 改变状态
            $('.fabu').click(function () {
                state = '已发布';
            })
            $('.caogao').click(function () {
                state = '草稿';
            })
            // 取值
            let title = $('[name="title"]').val();
            let cate_id = $('[name="cate_id"]').val();
            let content = $('#editor').text();
            let cover_img;
            var dataURL = $image
                .cropper('getCroppedCanvas', { // 创建一个 Canvas 画布
                    width: 100,
                    height: 100
                }).toBlob(function (bold) {
                    console.log(bold);      //Blob {size: 24957, type: 'image/png'}
                    cover_img = bold;






                    // 给FormData添加值
                    let fd = new FormData();
                    fd.append('title', title);
                    fd.append('cate_id', cate_id);
                    fd.append('content', content);
                    fd.append('state', state);
                    fd.append('cover_img', cover_img);

                    console.log(fd);
                    console.log(title, cate_id, content, cover_img, state);


                    $.ajax({
                        url: '/my/article/add',
                        method: 'post',
                        data: fd,
                        // 提交FormData()文件需要关闭这两个
                        contentType: false,    //编码类型:'application/x-www-form-urlencoded'
                        processData: false,  //对formData进行解析

                        success: (data) => {
                            console.log(data);
                        },
                        error: (err) => {
                            console.log(err);
                        }
                    })







                })





        })



    </script>
</body>

</html>